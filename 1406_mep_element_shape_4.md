<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="run_prettify.js" type="text/javascript"></script>
<!---
<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js" type="text/javascript"></script>
-->
</head>

<!---

https://forums.autodesk.com/t5/revit-api/ifc-import-level-line-is-automatically-created/m-p/6041440
11524056 [IFC Import--Level line is automatically created]
11543951 [IFC Import--Level line is automatically created]

#dotnet #csharp
#fsharp #python
#grevit
#responsivedesign #typepad
#ah8 #augi #dotnet
#stingray #rendering
#3dweb #3dviewAPI #html5 #threejs #webgl #3d #mobile #vr #ecommerce
#Markdown #Fusion360 #Fusion360Hackathon
#javascript
#RestSharp #restAPI
#mongoosejs #mongodb #nodejs
#rtceur
#xaml
#3dweb #a360 #3dwebaccel #webgl @adskForge
@AutodeskReCap @Adsk3dsMax
#revitAPI #bim #aec #3dwebcoder #adsk #adskdevnetwrk @jimquanci @keanw
#au2015 #rtceur
#eraofconnection
#RMS @researchdigisus
@adskForge #3dwebaccel
#a360

Revit API, Jeremy Tammik, akn_include

IFC Import Levels and MEP Element Shapes #revitAPI #3dwebcoder @AutodeskRevit #bim #aec #adsk #adskdevnetwrk

I answered far too many threads on the Revit API discussion forum in the past few days to list them all, so I'll just pick out two cases of special interest today
&ndash; Levels generated by IFC import
&ndash; Determining MEP duct and pipe element shape...

-->

### IFC Import Levels and MEP Element Shapes

I answered far too many threads on
the [Revit API discussion forum](https://forums.autodesk.com/t5/revit-api/bd-p/160) in
the past few days to list them all, so I'll just pick out two cases of special interest today:

- [Levels generated by IFC import](#2)
- [Determining MEP duct and pipe element shape](#3)


#### <a name="2"></a>Levels Generated by IFC Import

Here is a little detail to watch out when importing an IFC file: Revit may generate a level for you automatically under certain circumstances.

This issue was raised by David Robison, [Design Master Electrical RT](http://www.designmaster.biz/revit), in the discussion thread
on [IFC import &ndash; level line is automatically created](https://forums.autodesk.com/t5/revit-api/ifc-import-level-line-is-automatically-created/m-p/6041440):

**Question:** I have an [IFC file](zip/ifc_level_line.zip) to be imported into Revit. When it is imported, a level line at 0 m is included in each elevation. I can turn this off in each elevation manually. Is there a way to suppress it automatically?

<center>
<img src="img/ifc_level_added_1.png" alt="Level added during IFC import" width="600">
</center>

**Answer:** Here is the discussion we had on this with the development team:

[Q] Is there any automated way to remove or disable the level added in elevation view by the IFC import?

[A] Revit needs at least one building story. This file doesn’t seem to have any levels in it, so it is creating a default one. This seems to be standard behaviour.

[Q] Does that mean there is no way to automatically disable the default level display? Should I file a wish for it?

[A] I don’t think it would make much sense to make a wish for this. There has to be a level in a Revit file, and default view templates show levels. I might not fully understand his issue, but I am not sure exactly what the wish list item would be.

[Q] The reason it that several levels already exist in the current project, especially there is a “Level 1”. When IFC is imported, it creates another “Level 1” with 0 m elevation, which is redundant.

[A] OK, I think I see the issue here.

In general, we expect IFC files to have at least one building story in them. If they don’t, we’ll create one.

If they do, we will reuse the Level 1 already existing in the template to avoid exactly the case below. In this case, though, because we are creating a level – not reading one from the IFC file – we don’t do the matching that we’d normally do.

The workaround is simple: add a Level 1 to the IFC file.

We'll deal better with the case where there are no levels in the IFC file in the future.



#### <a name="3"></a>Determining MEP Duct and Pipe Element Shape

This is an old topic that has been discussed several times in the past, brought up again in the Revit API discussion forum thread
on [how to get duct shape](http://forums.autodesk.com/t5/revit-api/how-to-get-duct-shape/m-p/6053821).

In the past, we also spent some effort on solving it.

The solution now is really simple, since the introduction of the ElementType.FamilyName property in the Revit 2015 API:

**Question:** 有没有简单的办法直接获得风管的DuctShape?

我知道接口可以获得shape

*There is no simple way to directly get Duct Shape Duct?*

*I know it can be obtained in the user interface.*

**Answer:** You are asking how to determine the cross sectional shape of a duct element.

This used to be a pretty hard question, once upon a time, and several different approaches could be taken, e.g. geometrical analysis, as you can see from these previous discussions:

- [Distinguishing MEP Element Shape](http://thebuildingcoder.typepad.com/blog/2011/03/distinguishing-mep-element-shape.html)
- [Improved MEP Element Shape](http://thebuildingcoder.typepad.com/blog/2011/05/improved-mep-element-shape-and-mount-ararat.html)

Another way to achieve this is to open the duct fitting family and query the DuctConnector element for its Shape property, as explained by Joe Ye
in [how to get the duct section shape for duct type object](http://adndevblog.typepad.com/aec/2013/03/how-to-get-the-duct-section-shape-for-duct-type-object.html).

Unfortunately, opening the family is quite a costly operation.

From Revit 2015 onwards, the simplest an most effective method to achieve what you need is to query the [ElementType.FamilyName property](http://thebuildingcoder.typepad.com/blog/2014/04/whats-new-in-the-revit-2015-api.html#4.05).

In your case, that might look like this:

<pre class="code">
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;summary&gt;</span>
&nbsp; <span class="gray">///</span><span class="green"> Determine element shape from its </span>
&nbsp; <span class="gray">///</span><span class="green"> element type's family name property.</span>
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;/summary&gt;</span>
&nbsp; <span class="blue">static</span> <span class="blue">public</span> <span class="blue">string</span> GetElementShape4(
&nbsp; &nbsp; <span class="teal">Element</span> e )
&nbsp; {
&nbsp; &nbsp; <span class="blue">string</span> shape = <span class="maroon">&quot;unknown&quot;</span>;
&nbsp;
&nbsp; &nbsp; <span class="teal">ElementId</span> tid = e.GetTypeId();
&nbsp;
&nbsp; &nbsp; <span class="blue">if</span>( <span class="teal">ElementId</span>.InvalidElementId != tid )
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; <span class="teal">Document</span> doc = e.Document;
&nbsp;
&nbsp; &nbsp; &nbsp; <span class="teal">ElementType</span> etyp = doc.GetElement( tid )
&nbsp; &nbsp; &nbsp; &nbsp; <span class="blue">as</span> <span class="teal">ElementType</span>;
&nbsp;
&nbsp; &nbsp; &nbsp; <span class="blue">if</span>( <span class="blue">null</span> != etyp )
&nbsp; &nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; shape = etyp.FamilyName;
&nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="blue">return</span> shape;
&nbsp; }
</pre>

I added this code
to [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples)
[release 2016.0.126.3](https://github.com/jeremytammik/the_building_coder_samples/releases/tag/2016.0.126.3),
in the module [CmdMepElementShape.cs, in lines 721-745](https://github.com/jeremytammik/the_building_coder_samples/blob/master/BuildingCoder/BuildingCoder/CmdMepElementShape.cs#L721-L745).

Here is the result of a test run on the first two elements in this sequence of rectangular ducts and transitions:

<center>
<img src="img/duct_shape_2016_01.png" alt="Two ducts and a transition" width="503">
</center>

Selecting the left-most duct:

<center>
<img src="img/duct_shape_2016_02.png" alt="Duct shape and all its connector shapes" width="383">
</center>

Selecting the transition in the middle:

<center>
<img src="img/duct_shape_2016_03.png" alt="Duct shape and all its connector shapes" width="398">
</center>

Charles Piro chimed in to the discussion and suggested querying the shape of each duct connector like this:

<pre class="code">
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;summary&gt;</span>
&nbsp; <span class="gray">///</span><span class="green"> Return shape of first end connector on given duct.</span>
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;/summary&gt;</span>
&nbsp; <span class="blue">public</span> <span class="teal">ConnectorProfileType</span> GetShape( <span class="teal">Duct</span> duct )
&nbsp; {
&nbsp; &nbsp; <span class="teal">ConnectorProfileType</span> ductShape
&nbsp; &nbsp; &nbsp; = <span class="teal">ConnectorProfileType</span>.Invalid;
&nbsp;
&nbsp; &nbsp; <span class="blue">foreach</span>( <span class="teal">Connector</span> c
&nbsp; &nbsp; &nbsp; <span class="blue">in</span> duct.ConnectorManager.Connectors )
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; <span class="blue">if</span>( c.ConnectorType == <span class="teal">ConnectorType</span>.End )
&nbsp; &nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; &nbsp; ductShape = c.Shape;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="blue">break</span>;
&nbsp; &nbsp; &nbsp; }
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="blue">return</span> ductShape;
&nbsp; }
</pre>

I modified that to return the shapes of all duct connectors like this:

<pre class="code">
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;summary&gt;</span>
&nbsp; <span class="gray">///</span><span class="green"> Return shape of all duct connectors.</span>
&nbsp; <span class="gray">///</span><span class="green"> </span><span class="gray">&lt;/summary&gt;</span>
&nbsp; <span class="blue">static</span> <span class="teal">ConnectorProfileType</span>[] GetProfileTypes(
&nbsp; &nbsp; <span class="teal">Duct</span> duct )
&nbsp; {
&nbsp; &nbsp; <span class="teal">ConnectorSet</span> connectors
&nbsp; &nbsp; &nbsp; = duct.ConnectorManager.Connectors;
&nbsp;
&nbsp; &nbsp; <span class="blue">int</span> n = connectors.Size;
&nbsp;
&nbsp; &nbsp; <span class="teal">ConnectorProfileType</span>[] profileTypes
&nbsp; &nbsp; &nbsp; = <span class="blue">new</span> <span class="teal">ConnectorProfileType</span>[n];
&nbsp;
&nbsp; &nbsp; <span class="blue">int</span> i = 0;
&nbsp;
&nbsp; &nbsp; <span class="blue">foreach</span>( <span class="teal">Connector</span> c <span class="blue">in</span> connectors )
&nbsp; &nbsp; {
&nbsp; &nbsp; &nbsp; profileTypes[i++] = c.Shape;
&nbsp; &nbsp; }
&nbsp; &nbsp; <span class="blue">return</span> profileTypes;
&nbsp; }
</pre>

Reporting the result of this method as well produces the following on the first rectangular duct, informing us of the shapes of the duct itself as well as all its connectors:

<center>
<img src="img/duct_shape_2016_04.png" alt="Duct shape and all its connector shapes" width="366">
</center>

The result for the transition is basically the same as before; since it is not a duct, its connectors are not accessed:

<center>
<img src="img/duct_shape_2016_05.png" alt="Transition connectors are currently not explored" width="366">
</center>

Of course, you can very easily enhance the `GetProfileTypes` method to handle other MEP element types as well besides ducts.

That is left as an exercise to the reader &nbsp; :-)

The updated [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples)
[release 2016.0.126.4](https://github.com/jeremytammik/the_building_coder_samples/releases/tag/2016.0.126.4) includes Charles' suggestion as well.
