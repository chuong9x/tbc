<p><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head></p>
<!---

twitter:


Auto-executing an external command in the #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon 


linkedin:

#bim #DynamoBim #ForgeDevCon #Revit #API #IFC #SDK #AI #VisualStudio #Autodesk #AEC #adsk

the [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread

<p style="font-size: 80%; font-style:italic"></p>

-->

<h3>Auto-Executing an External Command</h3>
<p>I had an extensive discussion on automatically driving Revit from outside to auto-execute a simple functionality with no user input, originally implemented by an external command.</p>
<p>Also, a big thank you to all for the numerous congratulations on
the <a href="https://thebuildingcoder.typepad.com/blog/2019/08/11-years-and-revit-api-docs-full-text-search.html#2">announcement yesterday of The Building Coder's eleventh birthday</a>:</p>
<ul>
<li><a href="#2">Auto-executing an external command</a></li>
<li><a href="#3">Eleventh birthday congratulations</a></li>
</ul>
<h4><a name="2"></a> Autorun an External Command</h4>
<p><strong>Question:</strong> I have an external command that I would prefer to execute automatically to avoid the need to manually start up Revit, open the RVT model, and launch the command. How can this be achieved?</p>
<p><strong>Answer:</strong> Easy to solve, various approaches possible.</p>
<p>I would suggest starting out by trying to use a journal file as described here:</p>
<p>http://thebuildingcoder.typepad.com/blog/2010/07/ifc-import-and-conversion-journal-script.html</p>
<p>Another simple approach is to implement an event handler for the DocumentOpened event and automatically process the document immediately as soon as it is opened.</p>
<p>Shall I put together an add-in skeleton that executes automatically as soon as a document is loaded? then you can wire that up with the code you wish to execute.</p>
<p><strong>Question:</strong> I don't fully understand what " add-in skeleton that executes automatically as soon as a document is loaded" means.</p>
<p>But I understand the suggested solution. So if it is a step in the right direction - go right ahead</p>
<p><strong>Answer:</strong> in order for me to be able to start working on this, i would need a description of the top-level user interaction, the top-level Revit add-in API architecture , and the top-level RVT model context of the functionality you wish to run.</p>
<p>Is it a single external command?
Does the user push one single button to run it, and nothing else?
Does it need to be run on all RVT files in a given directory?
Can you implement a text file listing the RVT models to process?
Is any user input at all required?</p>
<p>[R] Currently, we just open the model, click our export button (similar to RevitLookup) and our code starts running on that specific model along with all the links, and writing everything to some external SQLite and JSON files. No user interaction is required besides opening the model and clicking our button.</p>
<p>It is fully synchronized (not async) so it "blocks" the GUI until it finishes.</p>
<p>I'm not sure what you mean about API, do you mean the interface we implement for Revit? if so, it's this one:</p>
<pre class="code">
  [Autodesk.Revit.Attributes.Transaction(Autodesk.Revit.Attributes.TransactionMode.ReadOnly)]
  internal class Main: IExternalCommand
  {
    public Result Execute(ExternalCommandData commandData, ref string message, ElementSet elements)
    {
         using (Document mainDoc = commandData.Application.ActiveUIDocument.Document)
      {
        using (RevitExport exporter = new RevitExport(mainDoc))
        {
          Stopwatch st = Stopwatch.StartNew();
          exporter.ExportEverything();
          Debug.Print($"Elapsed time: {st.Elapsed.TotalSeconds} seconds");
        }
      }
     }
  }
</pre>

<p>is that enough information?</p>
<p>I don't understand how this method can work on more "complicated" scenarios, e.g. it failed to load some of the links, the configuration file was corrupted (we load some JSON config file) or anything.</p>
<p>Not sure about the text file, since we just take all the links from the first one.</p>
<p><strong>Answer:</strong> Good. That is what I expected. This can easily be converted to autorun. The easiest solution is to use the manual user interface and the Revit journal file functionality like this:</p>
<ul>
<li>Rename your input file <code>X.rvt</code> to <code>input.rvt</code>.</li>
<li>Open Revit.</li>
<li>In the Revit user interface, perform the following steps steps:<ul>
<li>Open input.rvt.</li>
<li>Click your command button.</li>
<li>Shut down Revit.</li>
</ul>
</li>
<li>Look at the journal file generated by this process. My journal files are generated in the folder <code>C:\Users\jta\AppData\Local\Autodesk\Revit\Autodesk Revit 2020\Journals</code>, and the most recent one is named <code>journal.0019.txt</code>.</li>
<li>Rename the newest journal file to <code>process_input.txt</code></li>
</ul>
<p>Now you have completed the system. You can process a new model <code>Y.rvt</code> by executing the following:</p>
<p><code>copy Y.rvt input.rvt
"C:\Program Files\Autodesk\Revit 2020\Revit.exe" "C:\Users\jta\AppData\Local\Autodesk\Revit\Autodesk Revit 2020\Journals\journal.0019.txt"</code></p>
<p>These two lines can be placed into a Windows batch or command file, and the original input filename specified as an argument.</p>
<p>Here are two more detailed articles on using journal files to drive Revit:</p>
<ul>
<li>https://thebuildingcoder.typepad.com/blog/2010/07/ifc-import-and-conversion-journal-script.html</li>
<li>https://thebuildingcoder.typepad.com/blog/2009/07/journal-file-replay.html</li>
</ul>
<p>You can add some logging output to your external command, so that you have reliable information on whether the processing completed successfully.</p>
<p>The advantage of this approach is its simplicity.</p>
<p>The disadvantage is that you start up and close down Revit for each file processed.</p>
<p>However, since you can drive this automatically for any number of times, this is probably no problem if you have a couple of dozen files to process. If you have thousands, a more efficient approach would be needed.</p>
<p>More efficient approaches can easily be implemented inside your add-in code. For instance, you implement another external command that processes multiple files by reading a text file listing the files to process. It can open them one by one programmatically, and launch your process on each by calling a method taking a <code>Document</code> input argument. To prepare for this approach, rewrite your <code>Execute</code> method to extract the document from the command data, and pass that into a <code>Process</code> method taking the <code>Document</code> argument. With these two external command in place, you have the choice of processing either one single file or an entire list of files with one single click. </p>
<p>Since Revit is not built for processing hundreds of files in batch mode, this process will certainly fail sooner or later when working on a large number of files. Therefore, logging your progress is important. If you want the process to be fully automatic, you can implement additional functionality to check that it is still working, kill Revit if it has stopped, and restart again to continue processing whatever remains to be done. This kind of approach is documented in several articles:</p>
<ul>
<li><a href="https://thebuildingcoder.typepad.com/blog/2014/12/au-ends-and-batch-rendering-across-several-projects.html">Batch Rendering Across Several Projects</a></li>
<li><a href="https://thebuildingcoder.typepad.com/blog/2015/08/batch-processing-dwfx-links-and-future-proofing.html#4">Batch Processing Revit Documents</a></li>
<li><a href="https://thebuildingcoder.typepad.com/blog/2019/04/batch-processing-and-aspects-of-asstringvalue.html#2">Batch Processing Revit Families and Documents</a></li>
</ul>
<p>[R] Sound good, I'll go ahead. A few more questions:</p>
<ul>
<li>Do I have any way to add conditions? E.g., verify that all linked models are loaded?</li>
<li>What if the plugin was modified? In that case I usually need to manually press "load plugin" on the popup. Can it be automated</li>
</ul>
<p><strong>Answer:</strong> Good questions.</p>
<p>Easy answer:</p>
<p>The journal file is totally stupid. It will exactly reproduce what you did manually when it was recorded.</p>
<p>If something goes wrong, it will behave exactly as if you were sitting there manually typing and clicking in the user interface.</p>
<p>Therefore, the safest (and only possible) approach is to ensure that nothing does go wrong.</p>
<p>If anything fails to load, the process will fail.</p>
<p>Therefore the need to log each successful processing and check afterwards that everything worked.</p>
<p>To answer your qeustions:</p>
<ul>
<li>Add conditions, e.g., verify that linked models are loaded?</li>
</ul>
<p>You can add such a check to your <code>Process</code> method and terminate gracefully if something is missing. Add the check to the external command first, ensure that it works and does something sensible in manual mode.</p>
<ul>
<li>What if the plugin was modified? In that case I usually need to manually press "load plugin" on the popup. Can it be automated?</li>
</ul>
<p>The warning message can be eliminated completely by signing the DLL. This issue is discussed extensively in the forum thread
on <a href="http://forums.autodesk.com/t5/revit-api/code-signing-of-revit-addins/m-p/5981560">code signing of Revit add-ins</a>.
The solution is documented in the Revit online help section
on <a href="https://help.autodesk.com/view/RVT/2020/ENU/?guid=Revit_API_Revit_API_Developers_Guide_Introduction_Add_In_Integration_Digitally_Signing_Your_Revit_Add_in_html">digitally signing your Revit add-in</a>.</p>
<p>Alternatively, every time the DLL is modified, load it manually once and click 'Always load'. From then on, the message will not appear again, as long as the DLL is not modified.</p>
<h4><a name="3"></a> Thank you for your Eleventh Birthday Congratulations</h4>
<p>Thank you very much for the lively response and numerous congratulations on The Building Coder's eleventh birthday!</p>
<p>96 LinkedIn reactions, 5 Twitter retweets, 37 likes, 1693 impressions and 82 engagements, whatever those are.</p>
<p><a href="https://twitter.com/Gytaco/status/1164728843266957312?s=20">Adam Sheather on Twitter</a></p>
<blockquote>
<p>Congrats mate! You are still my go-to site for Revit API problems, and the wealth of knowledge and time you put into the blog has provided unimaginable benefit for the community! Thank you!</p>
</blockquote>
<p><a href="https://thebuildingcoder.typepad.com/blog/2019/08/11-years-and-revit-api-docs-full-text-search.html#comment-4588231441">Matt Taylor in a comment</a></p>
<blockquote>
<p>Happy birthday TBC!</p>
</blockquote>
<p><a href="https://www.linkedin.com/feed/update/urn:li:activity:6570246697056780288?commentUrn=urn%3Ali%3Acomment%3A%28activity%3A6570246697056780288%2C6570455407364571136%29">Amedeo Papi on LinkedIn</a></p>
<blockquote>
<p>Thank you Jeremy Tammik for everything you do for the #Autodesk users interested in development and programming!</p>
</blockquote>
<p><a href="https://www.linkedin.com/feed/update/urn:li:activity:6570246697056780288?commentUrn=urn%3Ali%3Acomment%3A%28activity%3A6570246697056780288%2C6570335510227632128%29">Philippe Leefsma on LinkedIn</a></p>
<blockquote>
<p>It will remain useful to Revit developers across the entire galaxy for centuries &nbsp; ;)</p>
</blockquote>
<p><center>
<img src="img/tbc_11_twitter_engagements.png" alt="Twitter engagements" width="600">
</center></p>