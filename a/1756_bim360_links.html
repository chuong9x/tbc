<p><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head></p>
<!---

twitter:

 in the #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon

&ndash;
...

linkedin:


#bim #DynamoBim #ForgeDevCon #Revit #API #IFC #SDK #AI #VisualStudio #Autodesk #AEC #adsk

the [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread

-->

<h3>Accessing BIM360 Cloud Links</h3>
<h4><a name="2"></a> Accessing BIM360 Cloud Links</h4>
<p>My colleague Eason Kang researched how to access BIM360 file links in a Revit project and summarised the results for us:</p>
<p><strong>Question:</strong> In Revit 2017, I used a method based on <code>ExternalFileReferences</code> to report linked files hosted in BIM360.</p>
<p>In Revit 2019 this method no longer works.</p>
<p>2019-06-03 07:00 07:10 adn_aec <code>TransmissionData</code> <code>GetAllExternalFileReferenceIds</code> , used in the attached sample from Jeremyâ€™s blog, List Linked Files and TransmissionData, does not report links hosted in BIM360, and it reports local files that are linked only. This is an old sample.
2019-06-03 07:00 07:10 adn_aec The similar <code>ExternalFileUtils</code> <code>GetAllExternalFileReferences</code> method similarly does not return these items.</p>
<p>Has there been a change in this area?</p>
<p>Is there a different method we should be using?</p>
<p><strong>Answer:</strong> Neither of these two methods support cloud links in Revit 2018 or Revit 2019.</p>
<p>In Revit 2017, they appeared to work, because back then, the cloud links were downloaded as local copies by the Autodesk Desktop Connector before linking.</p>
<p>Nowadays, BIM360 cloud links are treated as external sources. This behaviour started from with Revit 2018.</p>
<p>Therefore, please use <code>ExternalResourceUtils</code> <code>GetAllExternalResourceReferences</code> instead.</p>
<p>Here is a working code snippet:</p>
<pre class="code">
// Obtain all external resource references (Saying BIM360 Cloud references and local file references this time)
var xrefs = ExternalResourceUtils.GetAllExternalResourceReferences(doc);
var msg = string.Empty;

try
{
    foreach (var eid in xrefs)
    {
        var elem = doc.GetElement(eid);
        if (elem == null) continue;

        var link = elem as RevitLinkType;  //!<<< Get RVT document links only this time
        if (link == null) continue;

        var map = link.GetExternalResourceReferences();
        var keys = map.Keys;

        foreach (var key in keys)
        {
            var reference = map[key];
            var dictinfo = reference.GetReferenceInformation(); //!<<< Contains Forge BIM360 ProjectId(i.e. LinkedModelModelId) & ModelId (i.e. LinkedModelModelId) if it's from BIM360 Docs. It can be used in ModelPathUtils#ConvertCloudGUIDsToCloudPath calls
            var displayName = reference.GetResourceShortDisplayName();  //!<<< Link Name shown on the Manage Links dialog
            var path = reference.InSessionPath;
        }

        try
        {
           //Load model temporarily to get the model path of the cloud link
            var result = link.Load();
            var mdPath = result.GetModelName();   //!<<< Link ModelPath for Revit internal use
            link.Unload(null);

            var path = ModelPathUtils.ConvertModelPathToUserVisiblePath(mdPath); //!<<< Convert model path to user visible path, i.e. saved Path shown on the Manage Links dialog
            var refType = link.AttachmentType;  //!<<< Reference Type shown on the Manage Links dialog
            msg += string.Format("{0} {1}\n", link.AttachmentType, path);
        }
        catch (Exception ex)
        {
            TaskDialog.Show("Revit", ex.Message);
        }
    }

    TaskDialog.Show("Revit", msg);
}
catch(Exception ex)
{
    TaskDialog.Show("Revit", ex.Message);
}
</pre>

<p>And the result snapshots:</p>
<p><center>
<img src="img/bim360_links_1.png" alt="BIM360 link" width="352">
</center></p>
<p><center>
<img src="img/bim360_links_2.png" alt="BIM360 link" width="876">
</center></p>
<p>Many thanks to Eason for this research and clear explanation!</p>
<h4><a name="3"></a> Retrieve RVT Preview Thumbnail Image with Python</h4>
<p>https://thebuildingcoder.typepad.com/blog/2017/06/determining-rvt-file-version-using-python.html#comment-4484205626</p>
<p>Franco Tonutti</p>
<p>Hi Jeremy, how can I get the preview image of a .rfa file? I'm trying the following without success</p>
<p>import os.path as op
  import olefile</p>
<p>def get_rvt_preview(rvt_file):
  if op.exists(rvt_file):
  if olefile.isOleFile(rvt_file):
  rvt_ole = olefile.OleFileIO(rvt_file)
  bfi = rvt_ole.openstream("RevitPreview4.0")
  readed = bfi.read()
  f = open('my_file.bmp', 'w+b')
  f.write(readed)
  f.close()
  else:
  print("file does not apper to be an ole file: {}".format(rvt_file))
  else:
  print("file not found: {}".format(rvt_file))</p>
<p>Thumbnail</p>
<p>jeremy tammik --&gt; Franco Tonutti</p>
<p>Dear Franco,</p>
<p>Sorry, no idea. I have not looked into this for a while. Take a look at the other explorations reading RVT files without using the Revit API:</p>
<p>http://thebuildingcoder.typepad.com/blog/2010/06/open-revit-ole-storage.html
http://thebuildingcoder.typepad.com/blog/2013/01/basic-file-info-and-rvt-file-version.html
https://thebuildingcoder.typepad.com/blog/2015/09/lunar-eclipse-and-custom-file-properties.html#3
http://thebuildingcoder.typepad.com/blog/2016/02/reading-an-rvt-file-without-revit.html
http://thebuildingcoder.typepad.com/blog/2017/06/determining-rvt-file-version-using-python.html</p>
<p>If that does not help, I would suggest asking the larger community in the Revit API discussion fourm:</p>
<p>https://forums.autodesk.com/t5/revit-api-forum/bd-p/160</p>
<p>Cheers, Jeremy.</p>
<p>https://thebuildingcoder.typepad.com/blog/2017/06/determining-rvt-file-version-using-python.html#comment-4486812442</p>
<p>Franco Tonutti  jeremy tammik</p>
<p>Thank you very much, I could solve the problem by looking for the signature png</p>
<p>def get_rvt_preview(rvt_file, png_path):
if op.exists(rvt_file):
if olefile.isOleFile(rvt_file):</p>
<h1>Open ole file</h1>
<p>rvt_ole = olefile.OleFileIO(rvt_file)
bfi = rvt_ole.openstream("RevitPreview4.0")
readed = bfi.read()</p>
<h1>Find png signature</h1>
<p>readed_hex = readed.hex()
pos = readed_hex.find('89504e470d0a1a0a')
png_hex = readed_hex[pos:]
data = bytes.fromhex(png_hex)</p>
<h1>Save png file</h1>
<p>f = open(png_path, 'w+b')
f.write(data)
f.close()
else:
print("file does not apper to be an ole file: {}".format(rvt_file))
else:
print("file not found: {}".format(rvt_file))</p>
<p>/a/doc/revit/tbc/git/a/img/get_rvt_preview_image_py.png</p>
<h4><a name="3"></a> Failings of Political Establishment</h4>
<p>German 55-minute video about the failings of the established politicians who are driving the planet to the brink of catastrophe, ignoring all scientifical evidence</p>
<p>https://youtu.be/4Y1lZQsyuSQ</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4Y1lZQsyuSQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h4><a name="3"></a> Slow Macbook with kernel_task Several 100% CPU</h4>
<p>After three years or so, my Macbook Pro slowed down to an unusable crawl, especially when it got warm.</p>
<p>I looked at the results in the activity monitor, worrying about a virus, and only saw that the <code>kernel_task</code> was often using seveeral hundred percent of the CPU.</p>
<p>After weeks of this, I decided to upgrade OSX to the newest version to see whether that would help.</p>
<p>The upgrade went fine, and at least the situation was no worse.</p>
<p>Soon, however, it got wors still.</p>
<p>Finally, I found the solution:</p>
<p>This description
of <a href="https://www.howtogeek.com/310293/WHAT-IS-KERNEL_TASK-AND-WHY-IS-IT-RUNNING-ON-MY-MAC">what <code>kernel_task</code> is, and why it is running on my Mac</a>,
explains how <code>kernel_task</code> pretends to use CPU cycles to keep things cool.</p>
<p>That is confirmed by the Apple support thread
on <a href="https://support.apple.com/en-us/HT207359"><code>kernel_task</code> using a large percentage of your Mac CPU</a>.</p>
<p>In the next step, I looked at a helpful five-minute video
on <a href="https://youtu.be/ABs0L2VpLuA">how to clean MacBook Pro fans</a>.</p>
<p>Opening the Macbook is simple, but it does require the smallest screwdriver I have ever seen,
a <a href="https://en.wikipedia.org/wiki/List_of_screw_drives#Pentalobe">1.2 mm Pentalobe</a>:</p>
<p><center>
<img src="img/screwdriver.jpg" alt="Miniscule screwdriver" width="568">
</center></p>
<p>I never opened the PC before myself.</p>
<p>Using that, however, it was easy to open and blow out the dust clogging the fans with a pressurised air spray can.</p>
<p>One fan was so clogged with dust it was probably not running at all.</p>
<p>It seems better now. Please keep your fingers crossed for me that it stays that way and continues working &nbsp; :-)</p>
<h4><a name="3"></a> Dynamo Primer and Accessing the Revit API Compendium</h4>
<p>I already mentions
Paolo Serra's <a href="https://primer.dynamobim.org">Dynamo Primer</a>
discussing <a href="https://thebuildingcoder.typepad.com/blog/2018/12/dynamo-symbol-vs-type-and-exporter-exception.html#2">Revit API versus Dynamo for Revit</a>.</p>
<p>Here is another valuable related resource of his, on accessing the Revit API through Dynamo and Python:</p>
<blockquote>
<p>In terms of Dynamo for Revit you can refer to my <a href="https://primer.dynamobim.org">Dynamo Primer</a>,
specifically chapter 8 for the integration with Revit.</p>
<p>You can also check out the slide deck compendium I put together over the years that covers the basics of the Revit API and how to access it through Dynamo and Python: <a href="https://a360.co/2LfuM5p">a360.co/2LfuM5p</a>. It covers the following aspects:</p>
<ul>
<li>Dynamo Overview</li>
<li>User Interface</li>
<li>Graphs Management</li>
<li>Autodesk Standards</li>
<li>Visual Programming Principles</li>
<li>Filtering, Grouping &amp; Sorting</li>
<li>Dynamo-Excel Link</li>
<li>Design Script</li>
<li>Geometry Library</li>
<li>Automation Applications</li>
<li>Dynamo for Revit</li>
<li>Dynamo &amp; Python</li>
<li>Object Oriented Programming</li>
<li>Revit API Introduction</li>
<li>Next Steps</li>
</ul>
</blockquote>