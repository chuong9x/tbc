<p><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head></p>
<!---

 the #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon 

&ndash; Retrieve
...

of [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples/releases/tag/2019.0.145.4).

-->

<h3>Preparing a Revit Add-in for Design Automation</h3>
<p>Today I discuss the next step in
my <a href="https://github.com/jeremytammik/IfcSpaceZoneBoundaries">IfcSpaceZoneBoundaries project</a>.</p>
<p>This step deals with a completely different aspect than the previous discussions:
how to prepare a Revit add-in for use in the DA4R
or <a href="https://forge.autodesk.com/en/docs/design-automation/v3">Design Automation for Revit</a> environment,
which <a href="https://thebuildingcoder.typepad.com/blog/2019/01/design-automation-for-revit-in-public-beta.html">entered public beta</a> just last week.</p>
<p>I spent a considerable part of last weekend getting the DA4R version ready for testing, and figuring out how to best handle it in the VS solution:</p>
<ul>
<li><a href="#2">Context, add-in functionality and history</a> </li>
<li><a href="#3">Preparing the add-in for DA4R</a> </li>
<li><a href="#4">Local testing versus live deployment</a> </li>
<li><a href="#5">User defined input arguments for DA4R</a> </li>
<li><a href="#6">Logging of results</a> </li>
</ul>
<h4><a name="2"></a> Context, Add-In Functionality and History</h4>
<p>First, let's reiterate and update description of the architecture and data flow.</p>
<p>The add-in functionality that we wish to make use of in the DA4R environment consists in opening a Revit file, extracting the room and zone data stored in it and saving that to CSV.</p>
<p>The Revit document is actually an <code>.ifc.RVT</code> file created by the IFC linking-in process, currently executed on the desktop.</p>
<p>As it stands now, the <code>.ifc.RVT</code> file has to be generated by linking in the IFC file using a standard Revit add-in on the desktop, because the required functionality provided by the <a href="https://github.com/Autodesk/revit-ifc">revit-ifc open source</a> is not yet available in DA4R:</p>
<ul>
<li>DA4R currently does not support IFC &ndash; I raised a development request for that.</li>
<li>Therefore, the IFC processing currently has to take place in a Revit add-in on the desktop, described
in <a href="https://thebuildingcoder.typepad.com/blog/2019/02/link-in-and-analyse-ifc-file-zones-and-spaces.html#3">linking in an IFC file programmatically</a></li>
<li>The IFC linking generates a <code>.ifc.RVT</code> file.</li>
<li>The <code>.ifc.RVT</code> can be uploaded to DA4R and processed there. This requires no IFC functionality.</li>
</ul>
<p>Unfortunately, in this scenario, the IFC linking-in step takes place on the desktop, not in DA4R.
Since the add-in implements it, it can be fully automated.
A more direct solution would be to implement an IFC parser and extract the required information directly from there, bypassing the Revit conversion for that step.</p>
<p>Please also refer to these previous discussions leading up to where we are with this today:</p>
<ul>
<li><a href="https://thebuildingcoder.typepad.com/blog/2019/01/room-boundaries-to-csv-and-wpf-template.html">Exporting room boundaries to CSV</a></li>
<li><a href="https://thebuildingcoder.typepad.com/blog/2019/01/retrieving-linked-ifczone-elements-using-python.html">Retrieving linked <code>IfcZone</code> elements using Python</a></li>
<li><a href="https://thebuildingcoder.typepad.com/blog/2019/02/link-in-and-analyse-ifc-file-zones-and-spaces.html">Linking in and analysing IFC file zones and spaces</a></li>
</ul>
<h4><a name="3"></a> Preparing the Add-In for DA4R</h4>
<p>I spent some thought on how to best prepare the existing add-in project for creating the DA4R version.</p>
<p>Create a separate branch in GitHub?
Define compile-time switches?
Implement a multi-target Visual Studio project?</p>
<p>In the end, I decided that the simplest and most obvious approach would probably be best:</p>
<ul>
<li>Isolate almost all the add-in functionality into a separate <code>Exporter</code> class library</li>
<li>Reimplement and reduce the add-in to the bare minimum essentials, and call the <code>Exporter</code> to do all the work</li>
<li>Implement a new DA4R-specific DB application, also reduced to the bare minimum essentials</li>
</ul>
<p>Accordingly, the Visual Studio solution now contains three projects:</p>
<ul>
<li>Exporter &ndash; does all the work</li>
<li>Addin &ndash; the normal Revit desktop add-in</li>
<li>AppBundle &ndash; the Forge DA4R app</li>
</ul>
<p>Both the desktop add-in and the Forge DA4R <code>AppBundle</code> use the same <code>Exporter</code> class library and only contain minimal architectural code.</p>
<h4><a name="4"></a> Local Testing versus Live Deployment</h4>
<p>In addition to the separation between desktop add-in and DA4R appbundle, the latter can also be switched back and forth for local testing versus real live Forge DA4R deployment, by defining or undefining the constant <code>FORGE_DA4R_TEST_LOCALLY</code>
in <a href="https://github.com/jeremytammik/IfcSpaceZoneBoundaries/blob/master/AppBundle/App.cs">AppBundle/App.cs</a>.</p>
<p>Here is a <a href="https://github.com/jeremytammik/IfcSpaceZoneBoundaries/compare/2019.0.0.21..2019.0.0.22">diff between the two states</a>.</p>
<p>Depending on which state we are in, we use either the <code>ApplicationInitialized</code> or the <code>DesignAutomationReadyEvent</code> to run the application functionality.</p>
<p>Here is the entire external DB application implementation:</p>
<pre class="code">
<span style="color:green;">//#define&nbsp;FORGE_DA4R_TEST_LOCALLY</span>

<span style="color:blue;">#region</span>&nbsp;Namespaces
<span style="color:blue;">using</span>&nbsp;System;
<span style="color:blue;">using</span>&nbsp;System.IO;
<span style="color:blue;">using</span>&nbsp;System.Reflection;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.ApplicationServices;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.DB;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.DB.Events;
<span style="color:blue;">using</span>&nbsp;DesignAutomationFramework;
<span style="color:blue;">using</span>&nbsp;IfcSpaceZoneBoundaries.Exporter;
<span style="color:blue;">#endregion</span>

<span style="color:blue;">namespace</span>&nbsp;IfcSpaceZoneBoundaries.AppBundle
{
&nbsp;&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">App</span>&nbsp;:&nbsp;<span style="color:#2b91af;">IExternalDBApplication</span>
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;</span><span style="color:gray;">summary</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Export&nbsp;all&nbsp;linked-in&nbsp;IFC&nbsp;document&nbsp;rooms&nbsp;and&nbsp;zones</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/</span><span style="color:gray;">summary</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">int</span>&nbsp;ExportLinkedInIfcDocs(&nbsp;<span style="color:#2b91af;">Application</span>&nbsp;app&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>(&nbsp;0&nbsp;==&nbsp;app.Documents.Size&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">JtSettings</span>.Instance
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.IfcRvtInputFilePath;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Document</span>&nbsp;doc&nbsp;=&nbsp;app.OpenDocumentFile(&nbsp;path&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>(&nbsp;doc&nbsp;==&nbsp;<span style="color:blue;">null</span>&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;s&nbsp;=&nbsp;<span style="color:blue;">string</span>.Format(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a31515;">&quot;Could&nbsp;not&nbsp;open&nbsp;document&nbsp;{0}.&quot;</span>,&nbsp;path&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Log(&nbsp;s&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">InvalidOperationException</span>(&nbsp;s&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">RoomZoneExporter</span>.ExportAll(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}

<span style="color:blue;">#if</span>&nbsp;FORGE_DA4R_TEST_LOCALLY
<span style="color:gray;">&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;OnApplicationInitialized(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;sender,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationInitializedEventArgs&nbsp;e&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;`sender`&nbsp;is&nbsp;an&nbsp;Application&nbsp;instance:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Application&nbsp;app&nbsp;=&nbsp;sender&nbsp;as&nbsp;Application;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExportLinkedInIfcDocs(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
</span><span style="color:blue;">#else</span>&nbsp;<span style="color:green;">//&nbsp;if&nbsp;not&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">void</span>&nbsp;OnDesignAutomationReadyEvent(&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">object</span>&nbsp;sender,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">DesignAutomationReadyEventArgs</span>&nbsp;e&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;`sender`&nbsp;is&nbsp;an&nbsp;Application&nbsp;instance:</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Application</span>&nbsp;app&nbsp;=&nbsp;sender&nbsp;<span style="color:blue;">as</span>&nbsp;<span style="color:#2b91af;">Application</span>;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExportLinkedInIfcDocs(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
<span style="color:blue;">#endif</span>&nbsp;<span style="color:green;">//&nbsp;FORGE_DA4R_TEST_LOCALLY</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>&nbsp;OnStartup(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">ControlledApplication</span>&nbsp;a&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">Assembly</span>.GetExecutingAssembly().Location;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Init(&nbsp;<span style="color:#2b91af;">Path</span>.ChangeExtension(&nbsp;path,&nbsp;<span style="color:#a31515;">&quot;log&quot;</span>&nbsp;)&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtSettings</span>.Init(&nbsp;<span style="color:#2b91af;">Path</span>.ChangeExtension(&nbsp;path,&nbsp;<span style="color:#a31515;">&quot;json&quot;</span>&nbsp;)&nbsp;);

<span style="color:blue;">#if</span>&nbsp;FORGE_DA4R_TEST_LOCALLY
<span style="color:gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.ApplicationInitialized&nbsp;+=&nbsp;OnApplicationInitialized;
</span><span style="color:blue;">#else</span>&nbsp;<span style="color:green;">//&nbsp;if&nbsp;not&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">DesignAutomationBridge</span>.DesignAutomationReadyEvent&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+=&nbsp;OnDesignAutomationReadyEvent;
<span style="color:blue;">#endif</span>&nbsp;<span style="color:green;">//&nbsp;FORGE_DA4R_TEST_LOCALLY</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>.Succeeded;
&nbsp;&nbsp;&nbsp;&nbsp;}

&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>&nbsp;OnShutdown(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">ControlledApplication</span>&nbsp;a&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtSettings</span>.Save();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Done();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>.Succeeded;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}
</pre>

<h4><a name="5"></a> User Defined Input Arguments for DA4R</h4>
<p>I implemented the <code>JtSettings</code> class to demonstrate defining and passing in input parameters to a DA4R app via an input parameter file. </p>
<p>I simplified and minimised its interface to reduce the amount of code to be duplicated in the add-in and appbundle, e.g., by converting it to a self-contained singleton.</p>
<p>The interface to read the user-defined settings in DA4R currently consists of just two lines of code, as you can see above:</p>
<ul>
<li>A call to <code>JtSettings.Init</code> specifying the path to read from</li>
<li>A call to the setting itself via the static singleton instance:</li>
</ul>
<pre class="code">
&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">JtSettings</span>.Instance
&nbsp;&nbsp;&nbsp;&nbsp;.IfcRvtInputFilePath;
</pre>

<h4><a name="6"></a> Logging of Results</h4>
<p>Similarly to the enhanced settings class, I also streamlined the implementation of the <code>JtLogger</code> warning, error and result message logging system to make it easy and minimal to use from the two environments.</p>
<p>I hope you enjoyed my analysis and description and wish you lots of fun and success getting started with your own DA4R projects!</p>
<p><center>
<img src="img/log_raft.jpg" alt="Log raft" width="400">
</center></p>