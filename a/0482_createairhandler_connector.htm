<head>
<link rel="stylesheet" type="text/css" href="bc.css">
</head>

<!--

  SPR #198609 [error in Revit SDK sample CreateAirHandler] createairhandler error: connector not aligned with extrusion
  SPR #184840 [API wish: access to reverse duct connector direction]
  Greg Wesner RE: Create Air Handler sample

-->

<h3>Connector Direction and CreateAirHandler Sample</h3>

<p>Here is an update to the CreateAirHandler SDK sample provided by my colleague Greg Wesner together with an interesting analysis of MEP connector directions.

<!--

156_mep_2010_api.htm:<li><strong>CreateAirHandler:</st
199_family_api.htm:<h5>CreateAirHandler - RME</h5>
199_family_api.htm:<p>CreateAirHandler is a Revit MEP
219_mep_api.htm:<li>CreateAirHandler: Create an air ha
362_mep_2011_api.htm:<li>CreateAirHandler


130_mep_connectors.htm
204_rvtmgddbg_mep_connectors.htm
312_connector_orientation.htm
407_modeless_loose_connectors.htm
398_retrieve_mep_elements.htm

-->

<p>We looked at various aspects of MEP connectors several times in the past:

<ul>
<li>The difference between the 

<a href="http://thebuildingcoder.typepad.com/blog/2009/04/mep-connectors.html">
family connector elements</a> and the 

<a href="http://thebuildingcoder.typepad.com/blog/2009/04/mep-connectors.html">
project connector class</a>.

<li><a href="http://thebuildingcoder.typepad.com/blog/2009/08/fixing-rvtmgddbg-for-mep-connectors.html">
Enhancing RevitLookup for MEP</a>, previously known as RvtMgdDbg.

<li><a href="http://thebuildingcoder.typepad.com/blog/2010/03/connector-orientation.html">
Connector orientation</a>.

<li><a href="http://thebuildingcoder.typepad.com/blog/2010/06/retrieve-mep-elements-and-connectors.html">
Retrieving MEP elements and connectors</a>.

<li><a href="http://thebuildingcoder.typepad.com/blog/2010/07/modeless-loose-connectors.html">
Modeless loose connector navigator</a>.

</ul>

<p>The CreateAirHandler SDK sample shows how to create an MEP air handling device including its connectors.
It was introduced with the

<a href="http://thebuildingcoder.typepad.com/blog/2009/06/revit-mep-api.html">
Revit MEP 2010 API</a> and is also a

<a href="http://thebuildingcoder.typepad.com/blog/2009/08/the-revit-family-api.html#3">
family API sample</a>.

We since also discussed the

<a href="http://thebuildingcoder.typepad.com/blog/2009/09/the-revit-mep-api.html#6">
Revit MEP API in general</a> and the current situation in the

<a href="http://thebuildingcoder.typepad.com/blog/2010/05/the-revit-mep-2011-api.html">
Revit MEP 2011 API</a>.

<p>Here are Greg's observations and fixes:

<p>I found some issues with the CreateAirHandler SDK sample that are easy to fix.
Here is an image of the family as it is generated by the current sample implementation:</p>

<center>
<img src="img/CreateAirHandlerWrong.png" alt="Current CreateAirHandler result"/>
</center>

<p>Notice that the supply and return connectors and voids are not on the extruded solid that represents the air handler itself. Neither is the top hydronic supply. If you look at the supply connector (the smaller green rectangle), it should be in the same plane as the orange void. And it
s hard to see here, but the direction indicator for the return connector is pointing in the wrong direction.
Here is what I think it should look like:</p>

<center>
<img src="img/CreateAirHandlerCorrect.png" alt="Correct CreateAirHandler result"/>
</center>

<p>Here is

<a href="zip/CreateAirHandlerCommand.cs">
Command.cs</a>

containing the corrected command implementation, and here are

<a href="zip/CreateAirHandlerFixes.html">
the diffs, i.e. the changes I made</a> to fix these issues.

<h4>Connector Direction Reversal</h4>

<p>I originally implemented this update based on Revit 2010.
When I tested the same code on Revit 2011, I noticed is that the connector direction changed between Revit 2010 and 2011.

<p>After I fixed the air handler creation to my satisfaction for the 2010 version, the connectors point outwards as I expect:</p>

<center>
<img src="img/CreateAirHandler2010.png" alt="Connectors point outwards in Revit 2010"/>
</center>

<p>Running the exact same code in Revit 2011, however, causes them to point inwards instead:</p>

<center>
<img src="img/CreateAirHandler2011.png" alt="Connectors point inwards in Revit 2011"/>
</center>

<p>Note that the arrows for the supply and return connectors point inward in 2011. 
That's actually the opposite of the normal for the face of the object they are attached to. 
I verified this using Revit Lookup and looking at the normal of the faces I attach to.

<p>I also notice that the hydronic connectors at the bottom didn't change. 
The only thing I can think of is that the supply and return ducts actually attach to a void extrusion whereas the hydronic connectors attach to a solid. 
I guess that Revit inverts the normal for the connector when it is attached to a void extrusion?
That would explain why the arrows are reversed for the air connectors.

<h4>Reverse the Reversal</h4>

<p>This leads to an additional fix:

<p>In the initial code update, I changed the face that the connector is associated with to the outside face of the void extrusions. 
This results in the direction indicator pointing in towards the centre of the air handler in Revit 2011. 

<p>In order to keep them pointing outwards, you may want to associate the opposite face instead. 
To do so, in the CreateConnectors method, change m_planarFaces[0] to m_planarFaces[1].
That affects the following line for the supply air connector:

<pre class="code">
&nbsp; <span class="green">// create the Supply Air duct connector</span>
&nbsp; <span class="teal">DuctConnector</span> connSupplyAir 
&nbsp; &nbsp; = f.NewDuctConnector(
&nbsp; &nbsp; &nbsp; m_planarFaces[1].Reference,
&nbsp; &nbsp; &nbsp; <span class="teal">DuctSystemType</span>.SupplyAir );
</pre>

<p>Similarly, the following line for the return air connector:

<pre class="code">
&nbsp; <span class="green">// create the Return Air duct connector</span>
&nbsp; <span class="teal">DuctConnector</span> connReturnAir 
&nbsp; &nbsp; = f.NewDuctConnector(
&nbsp; &nbsp; &nbsp; m_planarFaces[1].Reference,
&nbsp; &nbsp; &nbsp; <span class="teal">DuctSystemType</span>.ReturnAir);
</pre>

<p>This will put the connectors on the inside faces of the voids, but at least the direction arrow will point in the correct direction. 
Normally, of course, one would expect the connector to be on the exterior of the unit.

