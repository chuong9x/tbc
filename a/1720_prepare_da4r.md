<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head>

<!---

twitter:

Preparing a Revit Add-in for Forge Design Automation #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon http://bit.ly/da4rprep

Today I discuss the next step in my IfcSpaceZoneBoundaries project, how to prepare a Revit add-in for use in the DA4R
or Design Automation for Revit environment and figuring out how to best handle it in the VS solution
&ndash; Context, add-in functionality and history
&ndash; Preparing the add-in for DA4R
&ndash; Local testing versus live deployment
&ndash; User defined input arguments for DA4R
&ndash; Logging of results...

linkedin:

Preparing a Revit add-in for Forge Design Automation #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon 

Today I discuss the next step in my IfcSpaceZoneBoundaries project, how to prepare a Revit add-in for use in the DA4R
or Design Automation for Revit environment and figuring out how to best handle it in the VS solution:

- Context, add-in functionality and history
- Preparing the add-in for DA4R
- Local testing versus live deployment
- User defined input arguments for DA4R
- Logging of results...

http://bit.ly/da4rprep

of [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples/releases/tag/2019.0.145.4).

-->

### Preparing a Revit Add-in for Design Automation

Today I discuss the next step in
my [IfcSpaceZoneBoundaries project](https://github.com/jeremytammik/IfcSpaceZoneBoundaries).

This step deals with a completely different aspect than the previous discussions:
how to prepare a Revit add-in for use in the DA4R
or [Design Automation for Revit](https://forge.autodesk.com/en/docs/design-automation/v3) environment,
which [entered public beta](https://thebuildingcoder.typepad.com/blog/2019/01/design-automation-for-revit-in-public-beta.html) just last week.

I spent a considerable part of last weekend getting the DA4R version ready for testing, and figuring out how to best handle it in the VS solution:

- [Context, add-in functionality and history](#2) 
- [Preparing the add-in for DA4R](#3) 
- [Local testing versus live deployment](#4) 
- [User defined input arguments for DA4R](#5) 
- [Logging of results](#6) 


#### <a name="2"></a> Context, Add-In Functionality and History

First, let's reiterate and update description of the architecture and data flow.

The add-in functionality that we wish to make use of in the DA4R environment consists in opening a Revit file, extracting the room and zone data stored in it and saving that to CSV.

The Revit document is actually an `.ifc.RVT` file created by the IFC linking-in process, currently executed on the desktop.

As it stands now, the `.ifc.RVT` file has to be generated by linking in the IFC file using a standard Revit add-in on the desktop, because the required functionality provided by the [revit-ifc open source](https://github.com/Autodesk/revit-ifc) is not yet available in DA4R:
 
- DA4R currently does not support IFC &ndash; I raised a development request for that.
- Therefore, the IFC processing currently has to take place in a Revit add-in on the desktop, described
in [linking in an IFC file programmatically](https://thebuildingcoder.typepad.com/blog/2019/02/link-in-and-analyse-ifc-file-zones-and-spaces.html#3)
- The IFC linking generates a `.ifc.RVT` file.
- The `.ifc.RVT` can be uploaded to DA4R and processed there. This requires no IFC functionality.
 
Unfortunately, in this scenario, the IFC linking-in step takes place on the desktop, not in DA4R.
Since the add-in implements it, it can be fully automated.
A more direct solution would be to implement an IFC parser and extract the required information directly from there, bypassing the Revit conversion for that step.

Please also refer to these previous discussions leading up to where we are with this today:

- [Exporting room boundaries to CSV](https://thebuildingcoder.typepad.com/blog/2019/01/room-boundaries-to-csv-and-wpf-template.html)
- [Retrieving linked `IfcZone` elements using Python](https://thebuildingcoder.typepad.com/blog/2019/01/retrieving-linked-ifczone-elements-using-python.html)
- [Linking in and analysing IFC file zones and spaces](https://thebuildingcoder.typepad.com/blog/2019/02/link-in-and-analyse-ifc-file-zones-and-spaces.html)


#### <a name="3"></a> Preparing the Add-In for DA4R

I spent some thought on how to best prepare the existing add-in project for creating the DA4R version.

Create a separate branch in GitHub?
Define compile-time switches?
Implement a multi-target Visual Studio project?

In the end, I decided that the simplest and most obvious approach would probably be best:

- Isolate almost all the add-in functionality into a separate `Exporter` class library
- Reimplement and reduce the add-in to the bare minimum essentials, and call the `Exporter` to do all the work
- Implement a new DA4R-specific DB application, also reduced to the bare minimum essentials

Accordingly, the Visual Studio solution now contains three projects:
 
- Exporter &ndash; does all the work
- Addin &ndash; the normal Revit desktop add-in
- AppBundle &ndash; the Forge DA4R app
 
Both the desktop add-in and the Forge DA4R `AppBundle` use the same `Exporter` class library and only contain minimal architectural code.
 
#### <a name="4"></a> Local Testing versus Live Deployment

In addition to the separation between desktop add-in and DA4R appbundle, the latter can also be switched back and forth for local testing versus real live Forge DA4R deployment, by defining or undefining the constant `FORGE_DA4R_TEST_LOCALLY`
in [AppBundle/App.cs](https://github.com/jeremytammik/IfcSpaceZoneBoundaries/blob/master/AppBundle/App.cs).

Here is a [diff between the two states](https://github.com/jeremytammik/IfcSpaceZoneBoundaries/compare/2019.0.0.21..2019.0.0.22).

Depending on which state we are in, we use either the `ApplicationInitialized` or the `DesignAutomationReadyEvent` to run the application functionality.

Here is the entire external DB application implementation:

<pre class="code">
<span style="color:green;">//#define&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
 
<span style="color:blue;">#region</span>&nbsp;Namespaces
<span style="color:blue;">using</span>&nbsp;System;
<span style="color:blue;">using</span>&nbsp;System.IO;
<span style="color:blue;">using</span>&nbsp;System.Reflection;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.ApplicationServices;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.DB;
<span style="color:blue;">using</span>&nbsp;Autodesk.Revit.DB.Events;
<span style="color:blue;">using</span>&nbsp;DesignAutomationFramework;
<span style="color:blue;">using</span>&nbsp;IfcSpaceZoneBoundaries.Exporter;
<span style="color:blue;">#endregion</span>
 
<span style="color:blue;">namespace</span>&nbsp;IfcSpaceZoneBoundaries.AppBundle
{
&nbsp;&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">App</span>&nbsp;:&nbsp;<span style="color:#2b91af;">IExternalDBApplication</span>
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;</span><span style="color:gray;">summary</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Export&nbsp;all&nbsp;linked-in&nbsp;IFC&nbsp;document&nbsp;rooms&nbsp;and&nbsp;zones</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/</span><span style="color:gray;">summary</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">int</span>&nbsp;ExportLinkedInIfcDocs(&nbsp;<span style="color:#2b91af;">Application</span>&nbsp;app&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>(&nbsp;0&nbsp;==&nbsp;app.Documents.Size&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">JtSettings</span>.Instance
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.IfcRvtInputFilePath;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Document</span>&nbsp;doc&nbsp;=&nbsp;app.OpenDocumentFile(&nbsp;path&nbsp;);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>(&nbsp;doc&nbsp;==&nbsp;<span style="color:blue;">null</span>&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;s&nbsp;=&nbsp;<span style="color:blue;">string</span>.Format(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a31515;">&quot;Could&nbsp;not&nbsp;open&nbsp;document&nbsp;{0}.&quot;</span>,&nbsp;path&nbsp;);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Log(&nbsp;s&nbsp;);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">InvalidOperationException</span>(&nbsp;s&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">RoomZoneExporter</span>.ExportAll(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
<span style="color:blue;">#if</span>&nbsp;FORGE_DA4R_TEST_LOCALLY
<span style="color:gray;">&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;OnApplicationInitialized(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;sender,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationInitializedEventArgs&nbsp;e&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;`sender`&nbsp;is&nbsp;an&nbsp;Application&nbsp;instance:
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Application&nbsp;app&nbsp;=&nbsp;sender&nbsp;as&nbsp;Application;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExportLinkedInIfcDocs(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
</span><span style="color:blue;">#else</span>&nbsp;<span style="color:green;">//&nbsp;if&nbsp;not&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">void</span>&nbsp;OnDesignAutomationReadyEvent(&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">object</span>&nbsp;sender,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">DesignAutomationReadyEventArgs</span>&nbsp;e&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;`sender`&nbsp;is&nbsp;an&nbsp;Application&nbsp;instance:</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Application</span>&nbsp;app&nbsp;=&nbsp;sender&nbsp;<span style="color:blue;">as</span>&nbsp;<span style="color:#2b91af;">Application</span>;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExportLinkedInIfcDocs(&nbsp;app&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;}
<span style="color:blue;">#endif</span>&nbsp;<span style="color:green;">//&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>&nbsp;OnStartup(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">ControlledApplication</span>&nbsp;a&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">Assembly</span>.GetExecutingAssembly().Location;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Init(&nbsp;<span style="color:#2b91af;">Path</span>.ChangeExtension(&nbsp;path,&nbsp;<span style="color:#a31515;">&quot;log&quot;</span>&nbsp;)&nbsp;);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtSettings</span>.Init(&nbsp;<span style="color:#2b91af;">Path</span>.ChangeExtension(&nbsp;path,&nbsp;<span style="color:#a31515;">&quot;json&quot;</span>&nbsp;)&nbsp;);
 
<span style="color:blue;">#if</span>&nbsp;FORGE_DA4R_TEST_LOCALLY
<span style="color:gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.ApplicationInitialized&nbsp;+=&nbsp;OnApplicationInitialized;
</span><span style="color:blue;">#else</span>&nbsp;<span style="color:green;">//&nbsp;if&nbsp;not&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">DesignAutomationBridge</span>.DesignAutomationReadyEvent&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+=&nbsp;OnDesignAutomationReadyEvent;
<span style="color:blue;">#endif</span>&nbsp;<span style="color:green;">//&nbsp;FORGE_DA4R_TEST_LOCALLY</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>.Succeeded;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>&nbsp;OnShutdown(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">ControlledApplication</span>&nbsp;a&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtSettings</span>.Save();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">JtLogger</span>.Done();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">ExternalDBApplicationResult</span>.Succeeded;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}
</pre>


#### <a name="5"></a> User Defined Input Arguments for DA4R

I implemented the `JtSettings` class to demonstrate defining and passing in input parameters to a DA4R app via an input parameter file. 
  
I simplified and minimised its interface to reduce the amount of code to be duplicated in the add-in and appbundle, e.g., by converting it to a self-contained singleton.

The interface to read the user-defined settings in DA4R currently consists of just two lines of code, as you can see above:

- A call to `JtSettings.Init` specifying the path to read from
- A call to the setting itself via the static singleton instance:

<pre class="code">
&nbsp;&nbsp;<span style="color:blue;">string</span>&nbsp;path&nbsp;=&nbsp;<span style="color:#2b91af;">JtSettings</span>.Instance
&nbsp;&nbsp;&nbsp;&nbsp;.IfcRvtInputFilePath;
</pre>

#### <a name="6"></a> Logging of Results

Similarly to the enhanced settings class, I also streamlined the implementation of the `JtLogger` warning, error and result message logging system to make it easy and minimal to use from the two environments.

I hope you enjoyed my analysis and description and wish you lots of fun and success getting started with your own DA4R projects!

<center>
<img src="img/log_raft.jpg" alt="Log raft" width="400">
</center>


<!--
ifc support in da4r: 
thread in #revit-io 
chrisd 5:38 PM, January 31st
Based on our current knowledge, we think we'll be able to support the normal range of IFC stuff. However, we are currently working on various other service-level requirements. We do expect to be working on customer requests over the next couple of months, but not for the next few sprints at least.
duellr 5:39 PM, January 31st
@tammikj @zhul @chrisd I created a spike, to discuss for our next sprint, so we can confirm if this is possible.
https://jira.autodesk.com/browse/RVTDA-923
RE: IFC support, specifically linking an IFC file into a blank RVT - Customer Requests - Forge Design Automation API for Revit
Ryan Duell wrote: Thank you Jeremy.  We are tracking this functionality in issue RVTDA-909.
-->
